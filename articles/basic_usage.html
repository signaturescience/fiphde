<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Basic Usage • fiphde</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Basic Usage">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fiphde</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic_usage.html">Basic Usage</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/signaturescience/fiphde/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Basic Usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/signaturescience/fiphde/blob/v2.1.0/vignettes/basic_usage.Rmd" class="external-link"><code>vignettes/basic_usage.Rmd</code></a></small>
      <div class="d-none name"><code>basic_usage.Rmd</code></div>
    </div>

    
    
<pre><code><span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span></code></pre>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The fiphde (<strong>f</strong>orecasting <strong>i</strong>nfluenza
in support of <strong>p</strong>ublic <strong>h</strong>ealth
<strong>de</strong>cision making) package provides utilities for
forecasting influenza hospitalizations in the United States. fiphde
includes functions for retrieving hospitalization time series data from
the HHS Protect system at <a href="https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/g62h-syeh" class="external-link">HealthData.gov</a>,
preparing raw data for forecasting, fitting time series and count
regression models to create probabilistic forecasts for influenza
hospitalizations at state and national levels, visualizing and
evaluating forecasts, and formatting forecasts for submission to <a href="https://www.cdc.gov/flu/weekly/flusight/index.html" class="external-link">FluSight</a>.</p>
<p>fiphde rhymes with “fifty,” as in the 50 states in the US.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>The fiphde package retrieves current data from HHS and CDC APIs and
fits models and forecasts using this data. This vignette uses data
current to May 28, 2022 (MMWR epidemiological week 21 of 2022). Running
the code here as written will produce different results depending on
<em>when</em> you run the code, as new data is constantly being added
and historical data is constantly being revised.</p>
<p>To get started, load the packages that are used in this vignette.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://signaturescience.github.io/fiphde/">fiphde</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="data-retrieval">Data retrieval<a class="anchor" aria-label="anchor" href="#data-retrieval"></a>
</h3>
<p>Prior to fitting any forecasts we need to first retrieve data from
the <a href="https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/g62h-syeh" class="external-link">HealthData.gov
COVID-19 Reported Patient Impact and Hospital Capacity by State
Timeseries API</a>. Running <code>get_hdgov_hosp(limitcols=TRUE)</code>
will initiate an API call with an argument to return only a selection of
fields relevant to flu hospitalization reporting.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_hdgov_hosp.html">get_hdgov_hosp</a></span><span class="op">(</span>limitcols <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 43,967 × 14</span></span></span>
<span><span class="co">#&gt;    state date       flu.admits flu.admits.cov flu.deaths flu.deaths.cov flu.icu</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> AL    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> HI    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> IN    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> LA    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> MN    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> MT    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> NC    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> PR    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> TX    2019-12-31         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> AL    2020-01-01         <span style="color: #BB0000;">NA</span>              0         <span style="color: #BB0000;">NA</span>              0      <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 43,957 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7 more variables: flu.icu.cov &lt;dbl&gt;, flu.tot &lt;dbl&gt;, flu.tot.cov &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   cov.admits &lt;dbl&gt;, cov.admits.cov &lt;dbl&gt;, cov.deaths &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   cov.deaths.cov &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="time-series-forecasting">Time series forecasting<a class="anchor" aria-label="anchor" href="#time-series-forecasting"></a>
</h3>
<p>We will first fit a time series model, creating an ensemble model
from ARIMA and exponential smoothing models. Time series modeling is
based on the tidyverts (<a href="https://tidyverts.org/" class="external-link uri">https://tidyverts.org/</a>) collection of packages for tidy
time series forecasting in R.</p>
<div class="section level4">
<h4 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h4>
<p>We need to initially prepare the data for a time series forecast. The
<code>prep_hdgov_hosp</code> function call below will limit to states
only (no territories), remove any data from an incomplete
epidemiological week (Sunday-Saturday), remove locations with little to
no reported hospitalizations over the last month, and further exclude
Washington DC from downstream analysis. The function aggregates total
number of cases at each epidemiological week at each location. This
function also adds in location FIPS codes, and joins in historical
influenza-like illness (ILI) and hospitalization mean values and ranks
by week. Historical indicators for ILI and hospitalizations are
summarized from <a href="https://gis.cdc.gov/grasp/fluview/fluportaldashboard.html" class="external-link">CDC
ILINet</a> and <a href="https://www.cdc.gov/flu/weekly/influenza-hospitalization-surveillance.htm" class="external-link">CDC
FluSurv-Net</a> respectively.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prep data</span></span>
<span><span class="va">prepped_hosp</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">hosp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/prep_hdgov_hosp.html">prep_hdgov_hosp</a></span><span class="op">(</span>statesonly<span class="op">=</span><span class="cn">TRUE</span>, min_per_week <span class="op">=</span> <span class="fl">0</span>, remove_incomplete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">abbreviation</span> <span class="op">!=</span> <span class="st">"DC"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped_hosp</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4,284 × 13</span></span></span>
<span><span class="co">#&gt;    abbreviation location week_start monday     week_end   epiyear epiweek</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> US           US       2020-10-18 2020-10-19 2020-10-24    <span style="text-decoration: underline;">2</span>020      43</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> US           US       2020-10-25 2020-10-26 2020-10-31    <span style="text-decoration: underline;">2</span>020      44</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> US           US       2020-11-01 2020-11-02 2020-11-07    <span style="text-decoration: underline;">2</span>020      45</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> US           US       2020-11-08 2020-11-09 2020-11-14    <span style="text-decoration: underline;">2</span>020      46</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> US           US       2020-11-15 2020-11-16 2020-11-21    <span style="text-decoration: underline;">2</span>020      47</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> US           US       2020-11-22 2020-11-23 2020-11-28    <span style="text-decoration: underline;">2</span>020      48</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> US           US       2020-11-29 2020-11-30 2020-12-05    <span style="text-decoration: underline;">2</span>020      49</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> US           US       2020-12-06 2020-12-07 2020-12-12    <span style="text-decoration: underline;">2</span>020      50</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> US           US       2020-12-13 2020-12-14 2020-12-19    <span style="text-decoration: underline;">2</span>020      51</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> US           US       2020-12-20 2020-12-21 2020-12-26    <span style="text-decoration: underline;">2</span>020      52</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,274 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: flu.admits &lt;dbl&gt;, flu.admits.cov &lt;dbl&gt;, ili_mean &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ili_rank &lt;int&gt;, hosp_mean &lt;dbl&gt;, hosp_rank &lt;int&gt;</span></span></span></code></pre></div>
<p>Now let’s explore the data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped_hosp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">abbreviation</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"CA"</span>, <span class="st">"TX"</span>, <span class="st">"NY"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">week_end</span>, <span class="va">flu.admits</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">abbreviation</span>, scale<span class="op">=</span><span class="st">"free_y"</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_usage_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
<p>What states had the highest admissions over the 2021-2022 flu
season?</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped_hosp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">abbreviation</span><span class="op">!=</span><span class="st">"US"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">week_start</span><span class="op">&gt;=</span><span class="st">"2021-07-01"</span> <span class="op">&amp;</span> <span class="va">week_end</span><span class="op">&lt;</span><span class="st">"2022-06-30"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">abbreviation</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>total.flu.admits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">flu.admits</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">total.flu.admits</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>caption<span class="op">=</span><span class="st">"Top 10 states with highest flu hospitalizations in 2021-2022."</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Top 10 states with highest flu hospitalizations in
2021-2022.</caption>
<thead><tr class="header">
<th align="left">abbreviation</th>
<th align="right">total.flu.admits</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">TX</td>
<td align="right">7164</td>
</tr>
<tr class="even">
<td align="left">FL</td>
<td align="right">4550</td>
</tr>
<tr class="odd">
<td align="left">PA</td>
<td align="right">3286</td>
</tr>
<tr class="even">
<td align="left">CA</td>
<td align="right">3233</td>
</tr>
<tr class="odd">
<td align="left">NY</td>
<td align="right">3073</td>
</tr>
<tr class="even">
<td align="left">AZ</td>
<td align="right">2819</td>
</tr>
<tr class="odd">
<td align="left">MI</td>
<td align="right">2511</td>
</tr>
<tr class="even">
<td align="left">OK</td>
<td align="right">2358</td>
</tr>
<tr class="odd">
<td align="left">OH</td>
<td align="right">2169</td>
</tr>
<tr class="even">
<td align="left">MA</td>
<td align="right">2141</td>
</tr>
</tbody>
</table>
<p>Next let’s turn this into a <a href="https://tsibble.tidyverts.org/" class="external-link">tsibble</a>. tsibble objects are
tibbles with an <em>index</em> variable describing the inherent ordering
from past to present, and a <em>key</em> that defines observational
units over time. The <code>make_tsibble</code> function provides a
convenience wrapper around <code><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html" class="external-link">tsibble::as_tsibble</a></code> using the
epidemiological week’s Monday as the weekly index and the location as
the key. Note that the specification of arguments for epidemiological
week / year and location key are passed as “bare” (unquoted) names of
columns storing this information in the original tibble.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped_hosp_tsibble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_tsibble.html">make_tsibble</a></span><span class="op">(</span><span class="va">prepped_hosp</span>,</span>
<span>                                     epiyear<span class="op">=</span><span class="va">epiyear</span>,</span>
<span>                                     epiweek<span class="op">=</span><span class="va">epiweek</span>,</span>
<span>                                     key<span class="op">=</span><span class="va">location</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped_hosp_tsibble</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 4,284 x 14 [1W]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       location [51]</span></span></span>
<span><span class="co">#&gt;    abbreviation location week_start monday        yweek week_end   epiyear</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;week&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> AL           01       2020-10-18 2020-10-19 2020 W43 2020-10-24    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> AL           01       2020-10-25 2020-10-26 2020 W44 2020-10-31    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> AL           01       2020-11-01 2020-11-02 2020 W45 2020-11-07    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> AL           01       2020-11-08 2020-11-09 2020 W46 2020-11-14    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> AL           01       2020-11-15 2020-11-16 2020 W47 2020-11-21    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> AL           01       2020-11-22 2020-11-23 2020 W48 2020-11-28    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> AL           01       2020-11-29 2020-11-30 2020 W49 2020-12-05    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> AL           01       2020-12-06 2020-12-07 2020 W50 2020-12-12    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> AL           01       2020-12-13 2020-12-14 2020 W51 2020-12-19    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> AL           01       2020-12-20 2020-12-21 2020 W52 2020-12-26    <span style="text-decoration: underline;">2</span>020</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,274 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7 more variables: epiweek &lt;dbl&gt;, flu.admits &lt;dbl&gt;, flu.admits.cov &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ili_mean &lt;dbl&gt;, ili_rank &lt;int&gt;, hosp_mean &lt;dbl&gt;, hosp_rank &lt;int&gt;</span></span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="fit-a-model-and-forecast">Fit a model and forecast<a class="anchor" aria-label="anchor" href="#fit-a-model-and-forecast"></a>
</h4>
<p>Next, let’s fit a time series model and create forecasts using the
<code>ts_fit_forecast</code> function. This function takes a tsibble
created as above, a forecast horizon in weeks, the name of the outcome
variable to forecast, and optional covariates to use in the ARIMA
model.</p>
<p>Here we fit a non-seasonal ARIMA model with the autoregressive term
(p) restricted to 1:2, order of integration for differencing (d)
restricted to 0:2, and the moving average (q) restricted to 0 (see
<code><a href="https://fable.tidyverts.org/reference/ARIMA.html" class="external-link">?fable::ARIMA</a></code> for more information). The model also fits a
non-seasonal exponential smoothing model (see <code><a href="https://fable.tidyverts.org/reference/ETS.html" class="external-link">?fable::ETS</a></code>
for details). In this example we do not fit an autoregressive neural
network model, but we could change <code>nnetar=NULL</code> to
<code>nnetar="AR(P=1)"</code> to do so (see <code>?fable::nnetar</code>
for details). We can also trim the data used in modeling, and here we
restrict to only include hospitalization data reported after January 1,
2021. By setting <code>ensemble=TRUE</code> we create an ensemble model
that averages the ARIMA and exponential smoothing models.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_fitfor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ts_fit_forecast.html">ts_fit_forecast</a></span><span class="op">(</span><span class="va">prepped_hosp_tsibble</span>,</span>
<span>                               horizon<span class="op">=</span><span class="fl">4L</span>,</span>
<span>                               outcome<span class="op">=</span><span class="st">"flu.admits"</span>,</span>
<span>                               trim_date <span class="op">=</span> <span class="st">"2021-01-01"</span>,</span>
<span>                               covariates<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>                               models<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>arima<span class="op">=</span><span class="st">'PDQ(0, 0, 0) + pdq(1:2, 0:2, 0)'</span>,</span>
<span>                                           ets<span class="op">=</span><span class="st">'season(method="N")'</span>,</span>
<span>                                           nnetar<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>, </span>
<span>                               ensemble<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The function will output messages describing the ARIMA and ETS model
formulas passed to <code><a href="https://fable.tidyverts.org/reference/ARIMA.html" class="external-link">fable::ARIMA</a></code> and
<code><a href="https://fable.tidyverts.org/reference/ETS.html" class="external-link">fable::ETS</a></code>.</p>
<pre><code>Trimming to 2021-01-01
ARIMA  formula: flu.admits ~ PDQ(0, 0, 0) + pdq(1:2, 0:2, 0) + hosp_rank + ili_rank
ETS    formula: flu.admits ~ season(method = "N")</code></pre>
<p>After fitting the models, the function then forecasts the outcome to
the specified number of weeks. Let’s take a look at the object returned
from this model fit + forecast. We see <code>$tsfit</code>, which gives
us the ARIMA, ETS, and ensemble model fits as list columns, one row per
location; <code>$tsfor</code> gives us the forecast for the next four
weeks, one row per model per location (key in the tsibble);
<code>$formulas</code> gives us the model formulas passed to fable
modeling functions; and if any models failed to converge we would see
those locations in <code>$nullmodels</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_fitfor</span></span>
<span><span class="co">#&gt; $tsfit</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A mable: 51 x 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:     location [51]</span></span></span>
<span><span class="co">#&gt;    location                       arima          ets      ensemble</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;model&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;model&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;model&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 01       &lt;LM w/ ARIMA(2,0,0) errors&gt; &lt;ETS(A,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 02       &lt;LM w/ ARIMA(1,0,0) errors&gt; &lt;ETS(A,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 04       &lt;LM w/ ARIMA(2,1,0) errors&gt; &lt;ETS(M,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 05       &lt;LM w/ ARIMA(2,1,0) errors&gt; &lt;ETS(A,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 06       &lt;LM w/ ARIMA(2,2,0) errors&gt; &lt;ETS(M,A,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 08       &lt;LM w/ ARIMA(1,1,0) errors&gt; &lt;ETS(A,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 09       &lt;LM w/ ARIMA(1,1,0) errors&gt; &lt;ETS(A,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 10       &lt;LM w/ ARIMA(2,1,0) errors&gt; &lt;ETS(A,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 12       &lt;LM w/ ARIMA(2,2,0) errors&gt; &lt;ETS(M,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 13       &lt;LM w/ ARIMA(2,1,0) errors&gt; &lt;ETS(A,N,N)&gt; &lt;COMBINATION&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 41 more rows</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $tsfor</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A fable: 612 x 10 [1W]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:     location, .model [153]</span></span></span>
<span><span class="co">#&gt;    location .model      yweek</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;week&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 01       arima    2022 W22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 01       arima    2022 W23</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 01       arima    2022 W24</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 01       arima    2022 W25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 01       ets      2022 W22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 01       ets      2022 W23</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 01       ets      2022 W24</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 01       ets      2022 W25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 01       ensemble 2022 W22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 01       ensemble 2022 W23</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 602 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7 more variables: flu.admits &lt;dist&gt;, .mean &lt;dbl&gt;, epiweek &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ili_mean &lt;dbl&gt;, ili_rank &lt;int&gt;, hosp_mean &lt;dbl&gt;, hosp_rank &lt;int&gt;</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $formulas</span></span>
<span><span class="co">#&gt; $formulas$arima</span></span>
<span><span class="co">#&gt; flu.admits ~ PDQ(0, 0, 0) + pdq(1:2, 0:2, 0) + hosp_rank + ili_rank</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55a42bc233e0&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $formulas$ets</span></span>
<span><span class="co">#&gt; flu.admits ~ season(method = "N")</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55a42bc233e0&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nullmodels</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 0 × 2</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 variables: location &lt;chr&gt;, model &lt;chr&gt;</span></span></span></code></pre></div>
<p>Next, we can format the forecasts for <a href="https://github.com/cdcepi/Flusight-forecast-data/blob/master/data-forecasts/README.md" class="external-link">submission
to FluSight</a> using the <code>format_for_submission</code>
function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formatted_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_for_submission.html">format_for_submission</a></span><span class="op">(</span><span class="va">hosp_fitfor</span><span class="op">$</span><span class="va">tsfor</span>, method <span class="op">=</span> <span class="st">"ts"</span>, format <span class="op">=</span> <span class="st">"legacy"</span><span class="op">)</span></span></code></pre></div>
<p>The list contains separate submission-ready tibbles, one element for
each type of model fitted.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formatted_list</span></span>
<span><span class="co">#&gt; $arima</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4,896 × 7</span></span></span>
<span><span class="co">#&gt;    forecast_date target            target_end_date location type  quantile value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       point <span style="color: #BB0000;">NA</span>       17   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       point <span style="color: #BB0000;">NA</span>       21   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2024-12-10    3 wk ahead inc f… 2022-06-18      01       point <span style="color: #BB0000;">NA</span>       20   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2024-12-10    4 wk ahead inc f… 2022-06-25      01       point <span style="color: #BB0000;">NA</span>       22   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       quan… 0.010    4    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2024-12-10    3 wk ahead inc f… 2022-06-18      01       quan… 0.010    1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2024-12-10    4 wk ahead inc f… 2022-06-25      01       quan… 0.010    3    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       quan… 0.025    2    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       quan… 0.025    6    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,886 more rows</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ensemble</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4,896 × 7</span></span></span>
<span><span class="co">#&gt;    forecast_date target            target_end_date location type  quantile value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       point <span style="color: #BB0000;">NA</span>       18   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       point <span style="color: #BB0000;">NA</span>       20   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2024-12-10    3 wk ahead inc f… 2022-06-18      01       point <span style="color: #BB0000;">NA</span>       19   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2024-12-10    4 wk ahead inc f… 2022-06-25      01       point <span style="color: #BB0000;">NA</span>       20   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       quan… 0.010    1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2024-12-10    3 wk ahead inc f… 2022-06-18      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2024-12-10    4 wk ahead inc f… 2022-06-25      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       quan… 0.025    3    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       quan… 0.025    4    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,886 more rows</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ets</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4,896 × 7</span></span></span>
<span><span class="co">#&gt;    forecast_date target            target_end_date location type  quantile value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       point <span style="color: #BB0000;">NA</span>       19   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       point <span style="color: #BB0000;">NA</span>       19   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2024-12-10    3 wk ahead inc f… 2022-06-18      01       point <span style="color: #BB0000;">NA</span>       19   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2024-12-10    4 wk ahead inc f… 2022-06-25      01       point <span style="color: #BB0000;">NA</span>       19   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2024-12-10    3 wk ahead inc f… 2022-06-18      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2024-12-10    4 wk ahead inc f… 2022-06-25      01       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2024-12-10    1 wk ahead inc f… 2022-06-04      01       quan… 0.025    2    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2024-12-10    2 wk ahead inc f… 2022-06-11      01       quan… 0.025    1    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4,886 more rows</span></span></span></code></pre></div>
<p>We can check to see if the submission is <a href="https://github.com/cdcepi/Flusight-forecast-data/blob/e1a2a05fa2bb065dfa80a7067c444394edde05e2/data-forecasts/README.md#Forecast-validation" class="external-link">valid</a>.
Note that this will fail if the expected date of the target dates and
current dates don’t line up. You’ll see a message noting <em>“The
submission target end dates do not line up with expected Saturdays by
horizon. Note if submission forecast date is not Sunday or Monday, then
forecasts are assumed to to start the following week.”</em> If
validation succeeds, the <code>$valid</code> element of the returned
list will be <code>TRUE</code>, and <code>FALSE</code> if any validation
checks fail.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/validate_forecast.html">validate_forecast</a></span><span class="op">(</span><span class="va">formatted_list</span><span class="op">$</span><span class="va">ensemble</span><span class="op">)</span></span></code></pre></div>
<p>Let’s plot the forecast with the observed data using the
<code>plot_forecast</code> function. Here we plot forecasts with the 50%
prediction interval for US, New York (FIPS 36) and Florida (FIPS
12).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_forecast.html">plot_forecast</a></span><span class="op">(</span><span class="va">prepped_hosp</span>, <span class="va">formatted_list</span><span class="op">$</span><span class="va">ensemble</span>, loc<span class="op">=</span><span class="st">"US"</span>, pi <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_usage_files/figure-html/unnamed-chunk-17-1.png" width="576"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_forecast.html">plot_forecast</a></span><span class="op">(</span><span class="va">prepped_hosp</span>, <span class="va">formatted_list</span><span class="op">$</span><span class="va">ensemble</span>, loc<span class="op">=</span><span class="st">"36"</span>, pi <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_usage_files/figure-html/unnamed-chunk-17-2.png" width="576"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_forecast.html">plot_forecast</a></span><span class="op">(</span><span class="va">prepped_hosp</span>, <span class="va">formatted_list</span><span class="op">$</span><span class="va">ensemble</span>, loc<span class="op">=</span><span class="st">"12"</span>, pi <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_usage_files/figure-html/unnamed-chunk-17-3.png" width="576"></p>
<p>Finally, we can pull out the ARIMA model parameters used for each
location to save for posterity or retrospective analysis.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_fitfor</span><span class="op">$</span><span class="va">tsfit</span><span class="op">$</span><span class="va">arima</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="st">"fit"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="st">"spec"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>location <span class="op">=</span> <span class="va">hosp_fitfor</span><span class="op">$</span><span class="va">tsfit</span><span class="op">$</span><span class="va">location</span>, .before <span class="op">=</span> <span class="st">"p"</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location p d q P D Q constant period</span></span>
<span><span class="co">#&gt; 1        01 2 0 0 0 0 0     TRUE     52</span></span>
<span><span class="co">#&gt; 2        02 1 0 0 0 0 0     TRUE     52</span></span>
<span><span class="co">#&gt; 3        04 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 4        05 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 5        06 2 2 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 6        08 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 7        09 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 8        10 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 9        12 2 2 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 10       13 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 11       15 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 12       16 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 13       17 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 14       18 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 15       19 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 16       20 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 17       21 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 18       22 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 19       23 2 1 0 0 0 0     TRUE     52</span></span>
<span><span class="co">#&gt; 20       24 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 21       25 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 22       26 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 23       27 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 24       28 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 25       29 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 26       30 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 27       31 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 28       32 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 29       33 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 30       34 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 31       35 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 32       36 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 33       37 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 34       38 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 35       39 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 36       40 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 37       41 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 38       42 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 39       44 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 40       45 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 41       46 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 42       47 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 43       48 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 44       49 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 45       50 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 46       51 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 47       53 2 2 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 48       54 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 49       55 1 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 50       56 2 1 0 0 0 0    FALSE     52</span></span>
<span><span class="co">#&gt; 51       US 2 1 0 0 0 0    FALSE     52</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="count-regression-forecasting">Count regression forecasting<a class="anchor" aria-label="anchor" href="#count-regression-forecasting"></a>
</h3>
<p>The time series methods above assume that the outcome has a
continuous distribution. When forecasting <em>counts</em> and especially
<em>small counts</em> (e.g., “how many influenza hospitalizations will
occur next week in Hawaii?”) alternative methods may have more desirable
properties. fiphde provides functionality to leverage count regression
models for forecasting influenza hospitalizations. Here we will
demonstrate how to implement a count regression modeling approach. The
example will step through the process of forecasting hospitalizations in
Hawaii by using influenza-like illness (ILI) and indicators of
historical hospitalization and ILI severity for the given
epidemiological weeks. The usage illustrates an automated tuning
procedure that finds the “best” models from possible covariates and
model families (e.g., Poisson, Quasipoisson, Negative binomial,
etc.).</p>
<div class="section level4">
<h4 id="ili-retrieval-and-prep">ILI retrieval and prep<a class="anchor" aria-label="anchor" href="#ili-retrieval-and-prep"></a>
</h4>
<p>Given that ILI will be a covariate in the count regression model, we
must first retrieve ILI data using the <code><a href="../reference/get_cdc_ili.html">get_cdc_ili()</a></code>
function, which is a wrapper around <code><a href="../reference/ilinet.html">ilinet()</a></code>. Here, we’re
only using recent ILI data (i.e., since 2019) and we further filter the
signal to only include Hawaii. ILI is subject to revision and may be
less reliable when initially reported, so we replace the current week
and one week previous with <a href="https://delphi.cmu.edu/nowcast/" class="external-link">Nowcast data</a>. Finally, we fit
a time series model to forecast ILI for the next four weeks.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ilidat</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/get_cdc_ili.html">get_cdc_ili</a></span><span class="op">(</span>region<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"state"</span><span class="op">)</span>, years<span class="op">=</span><span class="fl">2019</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Hawaii"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/replace_ili_nowcast.html">replace_ili_nowcast</a></span><span class="op">(</span><span class="va">.</span>, weeks_to_replace<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ilifor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast_ili.html">forecast_ili</a></span><span class="op">(</span><span class="va">ilidat</span>, horizon<span class="op">=</span><span class="fl">4L</span>, trim_date<span class="op">=</span><span class="st">"2020-03-01"</span><span class="op">)</span></span></code></pre></div>
<p>In the next step we are going to log transform weighted ILI and flu
admissions, so in this step we need to remove all the zeros. The fiphde
package provides the <code>mnz_replace</code> function which replaces
zeros in a variable with the smallest non-zero value of that
variable.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ilidat</span> <span class="op">&lt;-</span> <span class="va">ilidat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>weighted_ili<span class="op">=</span><span class="fu"><a href="../reference/mnz_replace.html">mnz_replace</a></span><span class="op">(</span><span class="va">weighted_ili</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ilifor</span><span class="op">$</span><span class="va">ilidat</span> <span class="op">&lt;-</span> <span class="va">ilifor</span><span class="op">$</span><span class="va">ilidat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ili<span class="op">=</span><span class="fu"><a href="../reference/mnz_replace.html">mnz_replace</a></span><span class="op">(</span><span class="va">ili</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ilifor</span><span class="op">$</span><span class="va">ili_future</span> <span class="op">&lt;-</span> <span class="va">ilifor</span><span class="op">$</span><span class="va">ili_future</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ili<span class="op">=</span><span class="fu"><a href="../reference/mnz_replace.html">mnz_replace</a></span><span class="op">(</span><span class="va">ili</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ilifor</span><span class="op">$</span><span class="va">ili_bound</span> <span class="op">&lt;-</span> <span class="va">ilifor</span><span class="op">$</span><span class="va">ili_bound</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ili<span class="op">=</span><span class="fu"><a href="../reference/mnz_replace.html">mnz_replace</a></span><span class="op">(</span><span class="va">ili</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we create our modeling dataset by combining the flu
admission data prepared above with the forecasted ILI data in future
weeks together with the historical severity data by epidemiological
week.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_hi</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">prepped_hosp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">abbreviation</span><span class="op">==</span><span class="st">"HI"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu">MMWRweek</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MMWRweek/man/MMWRweek2Date.html" class="external-link">MMWRweek2Date</a></span><span class="op">(</span><span class="va">epiyear</span>, <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ilifor</span><span class="op">$</span><span class="va">ilidat</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"epiyear"</span>, <span class="st">"location"</span>, <span class="st">"epiweek"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ili <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ili</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat_hi</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 84 × 15</span></span></span>
<span><span class="co">#&gt;    abbreviation location week_start monday     week_end   epiyear epiweek</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> HI           15       2020-10-18 2020-10-19 2020-10-24    <span style="text-decoration: underline;">2</span>020      43</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> HI           15       2020-10-25 2020-10-26 2020-10-31    <span style="text-decoration: underline;">2</span>020      44</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> HI           15       2020-11-01 2020-11-02 2020-11-07    <span style="text-decoration: underline;">2</span>020      45</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> HI           15       2020-11-08 2020-11-09 2020-11-14    <span style="text-decoration: underline;">2</span>020      46</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> HI           15       2020-11-15 2020-11-16 2020-11-21    <span style="text-decoration: underline;">2</span>020      47</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> HI           15       2020-11-22 2020-11-23 2020-11-28    <span style="text-decoration: underline;">2</span>020      48</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> HI           15       2020-11-29 2020-11-30 2020-12-05    <span style="text-decoration: underline;">2</span>020      49</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> HI           15       2020-12-06 2020-12-07 2020-12-12    <span style="text-decoration: underline;">2</span>020      50</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> HI           15       2020-12-13 2020-12-14 2020-12-19    <span style="text-decoration: underline;">2</span>020      51</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> HI           15       2020-12-20 2020-12-21 2020-12-26    <span style="text-decoration: underline;">2</span>020      52</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 74 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 8 more variables: flu.admits &lt;dbl&gt;, flu.admits.cov &lt;dbl&gt;, ili_mean &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ili_rank &lt;int&gt;, hosp_mean &lt;dbl&gt;, hosp_rank &lt;int&gt;, date &lt;date&gt;, ili &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="fit-a-model-and-forecast-1">Fit a model and forecast<a class="anchor" aria-label="anchor" href="#fit-a-model-and-forecast-1"></a>
</h4>
<p>First we create a list of different count regression models to fit.
We can inspect the formulations of each model. Note that these models
are specified using the <a href="https://github.com/reconverse/trending" class="external-link">trending package</a> and
internally the <a href="https://github.com/reconverse/trendeval" class="external-link">trendeval package</a> is
used to determine the best fitting approach.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">models</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    poisson <span class="op">=</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/trending_model.html" class="external-link">glm_model</a></span><span class="op">(</span><span class="va">flu.admits</span> <span class="op">~</span> <span class="va">ili</span> <span class="op">+</span> <span class="va">hosp_rank</span> <span class="op">+</span> <span class="va">ili_rank</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span>,</span>
<span>    quasipoisson <span class="op">=</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/trending_model.html" class="external-link">glm_model</a></span><span class="op">(</span><span class="va">flu.admits</span> <span class="op">~</span> <span class="va">ili</span> <span class="op">+</span> <span class="va">hosp_rank</span> <span class="op">+</span> <span class="va">ili_rank</span>, family <span class="op">=</span> <span class="st">"quasipoisson"</span><span class="op">)</span>,</span>
<span>    negbin <span class="op">=</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/trending_model.html" class="external-link">glm_nb_model</a></span><span class="op">(</span><span class="va">flu.admits</span> <span class="op">~</span> <span class="va">ili</span> <span class="op">+</span> <span class="va">hosp_rank</span> <span class="op">+</span> <span class="va">ili_rank</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">models</span><span class="op">$</span><span class="va">poisson</span></span>
<span><span class="co">#&gt; Untrained trending model:</span></span>
<span><span class="co">#&gt;     glm(formula = flu.admits ~ ili + hosp_rank + ili_rank, family = "poisson")</span></span>
<span><span class="va">models</span><span class="op">$</span><span class="va">quasipoisson</span></span>
<span><span class="co">#&gt; Untrained trending model:</span></span>
<span><span class="co">#&gt;     glm(formula = flu.admits ~ ili + hosp_rank + ili_rank, family = "quasipoisson")</span></span>
<span><span class="va">models</span><span class="op">$</span><span class="va">negbin</span></span>
<span><span class="co">#&gt; Untrained trending model:</span></span>
<span><span class="co">#&gt;     glm.nb(formula = flu.admits ~ ili + hosp_rank + ili_rank)</span></span></code></pre></div>
<p>We must next project covariates four weeks into the future, which we
can accomplish by pulling from the forecasted ILI and historical
severity data.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_cov</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ilifor</span><span class="op">$</span><span class="va">ili_future</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu">fiphde</span><span class="fu">:::</span><span class="va">historical_severity</span>, by<span class="op">=</span><span class="st">"epiweek"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">epiweek</span>,<span class="op">-</span><span class="va">epiyear</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ili <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">ili</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">new_cov</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   location   ili ili_mean ili_rank hosp_mean hosp_rank</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 15       0.655    1.02        12         0         0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 15       0.634    0.985       10         0         0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 15       0.642    0.946        9         0         0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 15       0.644    0.920        8         0         0</span></span></code></pre></div>
<p>Next we use fiphde’s <code>glm_wrap</code> function which attempts to
find the best-fitting model out of all the models supplied, and
specifies the prediction interval quantiles used in FluSight.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_wrap.html">glm_wrap</a></span><span class="op">(</span><span class="va">dat_hi</span>,</span>
<span>                new_covariates <span class="op">=</span> <span class="va">new_cov</span>,</span>
<span>                .models <span class="op">=</span> <span class="va">models</span>,</span>
<span>                alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.025</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.5</span>, by <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="va">forecasts</span><span class="op">$</span><span class="va">location</span> <span class="op">&lt;-</span> <span class="st">"15"</span></span></code></pre></div>
<p>We can take a quick look at the forecast output as well as different
aspects of the final fitted model.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">forecasts</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   epiweek epiyear quantile value location</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      22    <span style="text-decoration: underline;">2</span>022    0.01      0 15      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      22    <span style="text-decoration: underline;">2</span>022    0.025     0 15      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>      22    <span style="text-decoration: underline;">2</span>022    0.05      0 15      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>      22    <span style="text-decoration: underline;">2</span>022    0.1       0 15      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>      22    <span style="text-decoration: underline;">2</span>022    0.15      1 15      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>      22    <span style="text-decoration: underline;">2</span>022    0.2       1 15</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="co">#&gt; <span style="color: #949494;">&lt;trending_fit_tbl&gt; 1 x 3</span></span></span>
<span><span class="co">#&gt;   result warnings errors</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #949494;">&lt;glm&gt;</span>  <span style="color: #949494;">&lt;NULL&gt;</span>   <span style="color: #949494;">&lt;NULL&gt;</span></span></span>
<span><span class="va">res</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">fit</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">fitted_model</span><span class="op">$</span><span class="va">family</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">res</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">fit</span><span class="op">$</span><span class="va">fitted_model</span><span class="op">$</span><span class="va">coefficients</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>Next we prepare the data in the quantile format used by FluSight.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hi_glm_prepped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_for_submission.html">format_for_submission</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">forecasts</span>, method<span class="op">=</span><span class="st">"CREG"</span>, format <span class="op">=</span> <span class="st">"legacy"</span><span class="op">)</span></span>
<span><span class="va">hi_glm_prepped</span></span>
<span><span class="co">#&gt; $CREG</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 96 × 7</span></span></span>
<span><span class="co">#&gt;    forecast_date target            target_end_date location type  quantile value</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.010    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.025    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.050    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.100    0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.150    1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.200    1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.250    1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.300    1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.350    2    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2024-12-27    1 wk ahead inc f… 2022-06-04      15       quan… 0.400    2    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 86 more rows</span></span></span></code></pre></div>
<p>Finally, we can visualize the forecasted point estimates with the 90%
prediction interval alongside the observed data.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_forecast.html">plot_forecast</a></span><span class="op">(</span><span class="va">dat_hi</span>, <span class="va">hi_glm_prepped</span><span class="op">$</span><span class="va">CREG</span>, location<span class="op">=</span><span class="st">"15"</span>, pi<span class="op">=</span><span class="fl">.9</span><span class="op">)</span></span></code></pre></div>
<p><img src="basic_usage_files/figure-html/unnamed-chunk-27-1.png" width="576"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by VP Nagraj, Desiree Williams, Shakeel Jessa, Chris Hulme-Lowe, Stephen Turner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
